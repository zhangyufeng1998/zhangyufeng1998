import{_ as n,X as s,Y as a,a2 as t}from"./framework-a8949fcd.js";const p={},e=t(`<h2 id="_19-1-不安全rust" tabindex="-1"><a class="header-anchor" href="#_19-1-不安全rust" aria-hidden="true">#</a> 19.1 不安全Rust</h2><h3 id="匹配命名变量" tabindex="-1"><a class="header-anchor" href="#匹配命名变量" aria-hidden="true">#</a> 匹配命名变量</h3><ul><li>隐藏着第二个语言，它没有强制内存安全保证：Unsafe Rust <ul><li>和不同的Rust一样，但提供了额外的“超能力”</li></ul></li><li>Unsafe Rust存在的原因 <ul><li>静态分析是保守的 <ul><li>使用Unsafe Rust：我知道自己在做什么，并承担相应风险</li></ul></li><li>计算机本身就是不安全的，Rust需要能够进行底层系统编程</li></ul></li></ul><h3 id="unsafe超能力" tabindex="-1"><a class="header-anchor" href="#unsafe超能力" aria-hidden="true">#</a> Unsafe超能力</h3><ul><li>使用<code>unsafe</code>关键字来切换到unsafe Rust，开启一个块，里面放着unsafe代码</li><li>Unsafe Rust可执行四个操作： <ul><li>解引用原始指针</li><li>调用<code>unsafe</code>函数或方法</li><li>访问或者修改可变的静态变量</li><li>实现unsafe trait</li></ul></li><li>注意： <ul><li>unsafe并没有关闭借用检查或者停用其他安全检查</li><li>任何和内存相关的错误必须留在unsafe代码块里</li><li>尽可能隔离unsafe代码，最好将其封装在安全的抽象里，提供安全api</li></ul></li></ul><h3 id="解引用原始指针" tabindex="-1"><a class="header-anchor" href="#解引用原始指针" aria-hidden="true">#</a> 解引用原始指针</h3><ul><li>原始指针 <ul><li>可变的:<code>*mut T</code></li><li>不可变的:<code>*const T</code>意味着解引用后不能直接对其进行赋值</li><li>注意：<code>*</code>不是解引用符号，它是类型名的一部分</li></ul></li><li>与引用不同，原始指针： <ul><li>允许通过同时具有不可变和可变指针或多个和指向同一位置的可变指针来忽略借用规则</li><li>无法保证执行合理的内存</li><li>允许为null</li><li>不实现任何自动清理</li></ul></li><li>放弃保证的安全，换取更好的性能和与其它语言或硬件接口的能力</li></ul><div class="language-rust line-numbers-mode" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> num <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token comment">// 允许在安全代码块里创建原始指针，但是只能在不安全代码块里对其进行解引用</span>
    <span class="token keyword">let</span> r1 <span class="token operator">=</span> <span class="token operator">&amp;</span>num <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token keyword">i32</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> r2 <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> num <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> <span class="token keyword">i32</span><span class="token punctuation">;</span>

    num <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>

    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>r2 <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;r1 is: {}&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span>r1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;r2 is: {}&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span>r2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> address <span class="token operator">=</span> <span class="token number">0x012345usize</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> _r <span class="token operator">=</span> address <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token keyword">i32</span><span class="token punctuation">;</span>

    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span><span class="token operator">*</span>_r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行结果</p><div class="language-rust line-numbers-mode" data-ext="rs"><pre class="language-rust"><code>r1 is<span class="token punctuation">:</span> <span class="token number">7</span>
r2 is<span class="token punctuation">:</span> <span class="token number">7</span>
error<span class="token punctuation">:</span> process didn<span class="token lifetime-annotation symbol">&#39;t</span> exit successfully<span class="token punctuation">:</span> \`target\\debug\\rust_project<span class="token punctuation">.</span>exe\` <span class="token punctuation">(</span>exit code<span class="token punctuation">:</span> <span class="token number">0xc0000005</span><span class="token punctuation">,</span> <span class="token constant">STATUS_ACCESS_VIOLATION</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>为什么要使用原始指针？ <ul><li>与C语言进行接口</li><li>构建借用检查器无法理解的安全抽象</li></ul></li></ul><h3 id="调用unsafe函数或方法" tabindex="-1"><a class="header-anchor" href="#调用unsafe函数或方法" aria-hidden="true">#</a> 调用unsafe函数或方法</h3><ul><li>unsafe函数或方法：在定义前加上了unsafe关键字 <ul><li>调用前需要手动满足一些条件（主要看文档，Rust无法对这些条件进行验证）</li><li>需要在unsafe块里进行调用</li></ul></li></ul><h3 id="创建unsafe代码的安全抽象" tabindex="-1"><a class="header-anchor" href="#创建unsafe代码的安全抽象" aria-hidden="true">#</a> 创建unsafe代码的安全抽象</h3><ul><li>函数包含unsafe代码，并不意味着需要将整个函数标记为unsafe</li></ul><div class="language-rust line-numbers-mode" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>slice<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">split_at_mut</span><span class="token punctuation">(</span>values<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token keyword">i32</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mid<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token keyword">i32</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token keyword">i32</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> len <span class="token operator">=</span> values<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> ptr <span class="token operator">=</span> values<span class="token punctuation">.</span><span class="token function">as_mut_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// return a raw pointer</span>

    <span class="token macro property">assert!</span><span class="token punctuation">(</span>mid <span class="token operator">&lt;=</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span>
            <span class="token namespace">slice<span class="token punctuation">::</span></span><span class="token function">from_raw_parts_mut</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">// Calculates the offset from a pointer in byte</span>
            <span class="token namespace">slice<span class="token punctuation">::</span></span><span class="token function">from_raw_parts_mut</span><span class="token punctuation">(</span>ptr<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mid<span class="token punctuation">)</span><span class="token punctuation">,</span> len <span class="token operator">-</span> mid<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> v <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> r <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> v<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token function">split_at_mut</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="使用extern-函数调用外部代码" tabindex="-1"><a class="header-anchor" href="#使用extern-函数调用外部代码" aria-hidden="true">#</a> 使用extern 函数调用外部代码</h3><ul><li><code>extern</code>关键字：简化创建和使用外部函数接口（FFI）的过程。</li><li>外部函数接口（FFI，Foreign Function Interface）：它允许一种编程语言定义函数，并让其他语言能够调用这些函数</li><li>任何在<code>extern</code>中声明的函数都是不安全的</li><li>应用二进制接口（ABI，application binary interface）：定义在函数在汇编层的调用方式</li><li><code>“C”</code>ABI是常见的ABI，它遵循C语言的ABI</li></ul><h3 id="从其他语言调用rust函数" tabindex="-1"><a class="header-anchor" href="#从其他语言调用rust函数" aria-hidden="true">#</a> 从其他语言调用Rust函数</h3><ul><li>可以使用<code>extern</code>创建接口，其他语言通过他们可以调用Rust函数</li><li>在fn前添加<code>extern</code>关键字，并指定ABI</li><li>还需添加<code>#[no_mangle]</code>注解：避免Rust在编译时改变它的名称</li></ul><div class="language-rust line-numbers-mode" data-ext="rs"><pre class="language-rust"><code><span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> <span class="token keyword">fn</span> <span class="token function-definition function">call_from_c</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Just called a Rust function from C!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="访问或修改一个可变静态变量" tabindex="-1"><a class="header-anchor" href="#访问或修改一个可变静态变量" aria-hidden="true">#</a> 访问或修改一个可变静态变量</h3><ul><li>Rust支持全局变量，但因为所有权机制可能产生某些问题，例如数据竞争</li><li>在Rust中，全局变量叫做<code>静态(static)变量</code></li></ul><div class="language-rust line-numbers-mode" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">static</span> <span class="token constant">HELLO_WORLD</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span> <span class="token operator">=</span> <span class="token string">&quot;Hello, world!&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;name is: {}&quot;</span><span class="token punctuation">,</span> <span class="token constant">HELLO_WORLD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="静态变量" tabindex="-1"><a class="header-anchor" href="#静态变量" aria-hidden="true">#</a> 静态变量</h3><ul><li>静态变量与常量类似</li><li>命名：SCREAMING_SNAKE_CASE</li><li>必须标注类型</li><li>静态变量只能存储<code>&#39;static</code>生命周期的引用，无需显示标注</li><li>访问不可变静态变量时安全的</li></ul><h3 id="常量与不可变静态变量的区别" tabindex="-1"><a class="header-anchor" href="#常量与不可变静态变量的区别" aria-hidden="true">#</a> 常量与不可变静态变量的区别</h3><ul><li>静态变量：有固定的内存地址，使用它的值总会访问相同的数据</li><li>常量：允许使用他们的时候对数据进行复制</li><li>静态变量：可以是可变的，访问和修改静态可变变量时不安全的</li></ul><div class="language-rust line-numbers-mode" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">static</span> <span class="token keyword">mut</span> <span class="token constant">COUNTER</span><span class="token punctuation">:</span> <span class="token keyword">u32</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">add_to_count</span><span class="token punctuation">(</span>inc<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token constant">COUNTER</span> <span class="token operator">+=</span> inc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">add_to_count</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;COUNTER: {}&quot;</span><span class="token punctuation">,</span> <span class="token constant">COUNTER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="实现不安全的trait" tabindex="-1"><a class="header-anchor" href="#实现不安全的trait" aria-hidden="true">#</a> 实现不安全的trait</h3><p><code>pass!</code></p><h3 id="何时使用unsafe代码" tabindex="-1"><a class="header-anchor" href="#何时使用unsafe代码" aria-hidden="true">#</a> 何时使用unsafe代码</h3><ul><li>编译器无法保证内存安全，保证unsafe代码正确并不简单</li><li>有充足的理由使用unsafe代码时，就可以这样做</li><li>通过显式标记unsafe，就可以在出现问题时轻松定位</li></ul><h2 id="_19-2-高级trait" tabindex="-1"><a class="header-anchor" href="#_19-2-高级trait" aria-hidden="true">#</a> 19.2 高级trait</h2><h3 id="在trait定义中使用关联类型来指定占位类型" tabindex="-1"><a class="header-anchor" href="#在trait定义中使用关联类型来指定占位类型" aria-hidden="true">#</a> 在Trait定义中使用关联类型来指定占位类型</h3><ul><li>关联类型（associated type）是trait中的类型占位符，它可以用于trait方法的签名中 <ul><li>可以定义出包含某些类型的trait，而在实现前无需知道这些类型是什么</li></ul></li></ul><div class="language-rust line-numbers-mode" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">Iterator</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token type-definition class-name">Item</span><span class="token punctuation">;</span> <span class="token comment">// Item就是一个关联类型</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">next</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Item</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="关联类型与泛型的区别" tabindex="-1"><a class="header-anchor" href="#关联类型与泛型的区别" aria-hidden="true">#</a> 关联类型与泛型的区别</h3><ul><li><p>泛型</p><ul><li>每次实现trait时标注类型</li><li>可以为一个类型多次实现某个trait（不同的泛型参数）</li></ul></li><li><p>关联类型</p><ul><li>无需标注类型 （需要在里面指明类型）</li><li>无法为单个类型多次实现某个trait</li></ul></li></ul><h3 id="默认泛型参数和运算符重载" tabindex="-1"><a class="header-anchor" href="#默认泛型参数和运算符重载" aria-hidden="true">#</a> 默认泛型参数和运算符重载</h3><ul><li>可以在使用泛型参数时为泛型指定一个默认的具体类型</li><li>语法:<code>&lt;PlaceholderType=ConcreteType&gt;</code></li><li>这种技术常用于运算符重载</li><li>Rust不允许创建自己的运算符及重载任意的运算符 <ul><li>但可以通过实现<code>std::ops</code>中列出的那些trait来重载一部分相应的运算符</li></ul></li></ul><div class="language-rust line-numbers-mode" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>ops<span class="token punctuation">::</span></span><span class="token class-name">Add</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Debug, Copy, Clone, PartialEq)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Point</span> <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Add</span> <span class="token keyword">for</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token type-definition class-name">Output</span> <span class="token operator">=</span> <span class="token class-name">Point</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">add</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> other<span class="token punctuation">:</span> <span class="token class-name">Point</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span>
        <span class="token class-name">Point</span> <span class="token punctuation">{</span>
            x<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>x <span class="token operator">+</span> other<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
            y<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>y <span class="token operator">+</span> other<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>
        <span class="token class-name">Point</span> <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span> <span class="token operator">+</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token class-name">Point</span> <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="默认泛型参数的主要应用场景" tabindex="-1"><a class="header-anchor" href="#默认泛型参数的主要应用场景" aria-hidden="true">#</a> 默认泛型参数的主要应用场景</h3><ul><li>扩展一个类型而不破坏现有代码</li><li>允许在大部分用户都不需要的特定场景下进行自定义</li></ul><h3 id="完全限定语法-fully-qualified-syntax-如何调用同名方法" tabindex="-1"><a class="header-anchor" href="#完全限定语法-fully-qualified-syntax-如何调用同名方法" aria-hidden="true">#</a> 完全限定语法（Fully Qualified Syntax）如何调用同名方法</h3><div class="language-rust line-numbers-mode" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">trait</span> <span class="token type-definition class-name">Pilot</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">fly</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">trait</span> <span class="token type-definition class-name">Wizard</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">fly</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Human</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Pilot</span> <span class="token keyword">for</span> <span class="token class-name">Human</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">fly</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;This is your captain speaking.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Wizard</span> <span class="token keyword">for</span> <span class="token class-name">Human</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">fly</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Up!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Human</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">fly</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;*waving arms furiously*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> persion <span class="token operator">=</span> <span class="token class-name">Human</span><span class="token punctuation">;</span>
    persion<span class="token punctuation">.</span><span class="token function">fly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 调用的时本身的fly方法</span>
    <span class="token namespace">pilot<span class="token punctuation">::</span></span><span class="token function">fly</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token namespace">wizard<span class="token punctuation">::</span></span><span class="token function">fly</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-rust line-numbers-mode" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">trait</span> <span class="token type-definition class-name">Animal</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">baby_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">String</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Dog</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Dog</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">baby_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;Spot&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Animal</span> <span class="token keyword">for</span> <span class="token class-name">Dog</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">baby_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;puppy&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;A baby dog is called a {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Dog</span><span class="token punctuation">::</span><span class="token function">baby_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;A baby dog is called a {}&quot;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token class-name">Dog</span> <span class="token keyword">as</span> <span class="token class-name">Arunak</span><span class="token operator">&gt;</span><span class="token punctuation">::</span><span class="token function">baby_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>完全限定语法：<code>&lt;Type as Trait&gt;::function(receiver_if_methord,netx_arg,...)</code><ul><li>可以在任何调用函数或方法的地方使用</li><li>允许忽略那些从其他上下文推导出来的部分</li><li>当Rust无法区分你期望调用哪个具体实现的时候才需要使用这种语法</li></ul></li></ul><h3 id="使用supertrait来要求trait附带其他trait的功能" tabindex="-1"><a class="header-anchor" href="#使用supertrait来要求trait附带其他trait的功能" aria-hidden="true">#</a> 使用<code>supertrait</code>来要求trait附带其他trait的功能</h3><ul><li>需要在一个trait中使用其他trait的功能： <ul><li>需要被依赖的trait也被实现</li><li>哪个被间接依赖的trait就是当前trait的<code>supertrait</code></li></ul></li></ul><div class="language-rust line-numbers-mode" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>fmt<span class="token punctuation">;</span>

<span class="token keyword">trait</span> <span class="token type-definition class-name">OutlinePrint</span><span class="token punctuation">:</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span> <span class="token punctuation">{</span> <span class="token comment">// 冒号后面是被依赖的triat</span>
<span class="token keyword">fn</span> <span class="token function-definition function">outline_print</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> output <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> len <span class="token operator">=</span> output<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>len <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;*{}*&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>len <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;* {} *&quot;</span><span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;*{}*&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>len <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>len <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Point</span> <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">OutlinePrint</span> <span class="token keyword">for</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span> <span class="token keyword">for</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">fmt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Formatter</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Result</span> <span class="token punctuation">{</span>
        <span class="token macro property">write!</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">&quot;({}, {})&quot;</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span>
        x<span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">,</span>
        y<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    x<span class="token punctuation">.</span><span class="token function">outline_print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="使用newtype模式在外部类型上实现外部trait" tabindex="-1"><a class="header-anchor" href="#使用newtype模式在外部类型上实现外部trait" aria-hidden="true">#</a> 使用newtype模式在外部类型上实现外部trait</h3><ul><li>孤儿规则：只有当trait或类型定义在本地包时，才能为该类型实现这个trait <ul><li>使用newtype这个模式绕过这一规则 <ul><li>利用tuple struct（元组结构体）创建一个新的类型</li></ul></li></ul></li></ul><div class="language-rust line-numbers-mode" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>fmt<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Wrapper</span><span class="token punctuation">(</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span> <span class="token keyword">for</span> <span class="token class-name">Wrapper</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">fmt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Formatter</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Result</span> <span class="token punctuation">{</span>
        <span class="token macro property">write!</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">&quot;[{}]&quot;</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;, &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> w <span class="token operator">=</span> <span class="token class-name">Wrapper</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;w = {}&quot;</span><span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_19-3-高级类型" tabindex="-1"><a class="header-anchor" href="#_19-3-高级类型" aria-hidden="true">#</a> 19.3 高级类型</h2><h3 id="使用newtype模式实现类型的安全和抽象" tabindex="-1"><a class="header-anchor" href="#使用newtype模式实现类型的安全和抽象" aria-hidden="true">#</a> 使用newtype模式实现类型的安全和抽象</h3><ul><li>用来静态的保证各种值之间不会混淆并表明单位的值</li><li>为类型的某些细节提供抽象能力</li><li>通过轻量级的封装来隐藏内部实现细节</li></ul><h3 id="使用类型的别名创建同义词" tabindex="-1"><a class="header-anchor" href="#使用类型的别名创建同义词" aria-hidden="true">#</a> 使用类型的别名创建同义词</h3><ul><li>Rust提供了类型别名的功能： <ul><li>为现有类型生产另外的名称（同义词）</li><li>并不是一个现有的类型</li><li>使用type关键字</li></ul></li><li>主要用途：减少代码的字符重复</li></ul><div class="language-rust line-numbers-mode" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">type</span> <span class="token type-definition class-name">Kilometers</span> <span class="token operator">=</span> <span class="token keyword">i32</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> x<span class="token punctuation">:</span> <span class="token keyword">i32</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> y<span class="token punctuation">:</span> <span class="token class-name">Kilometers</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

<span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;x + y = {}&quot;</span><span class="token punctuation">,</span> x <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-rust line-numbers-mode" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">type</span> <span class="token type-definition class-name">Thunk</span> <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">Fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">&#39;static</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> f<span class="token punctuation">:</span> <span class="token class-name">Thunk</span> <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;hi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">takes_long_type</span><span class="token punctuation">(</span>f<span class="token punctuation">:</span> <span class="token class-name">Thunk</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// --snip--</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">returns_long_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Thunk</span> <span class="token punctuation">{</span>
    <span class="token comment">// --snip--</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-rust line-numbers-mode" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>fmt<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">Write</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">flush</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">write_all</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">write_fmt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> fmt<span class="token punctuation">:</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Arguments</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-rust line-numbers-mode" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">type</span> <span class="token type-definition class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>result<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">Write</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">flush</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">write_all</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">write_fmt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> fmt<span class="token punctuation">:</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Arguments</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="never-类型" tabindex="-1"><a class="header-anchor" href="#never-类型" aria-hidden="true">#</a> Never 类型</h3><ul><li>有一个名为<code>!</code>的特殊类型 <ul><li>他没有任何值，行话称为空类型（empty type）</li><li>我们倾向于叫他never类型，因为它在不返回的函数中充当返回类型</li></ul></li><li>不返回的函数也被称作发散函数（diverging function）</li></ul><h3 id="动态大小和sized-trait" tabindex="-1"><a class="header-anchor" href="#动态大小和sized-trait" aria-hidden="true">#</a> 动态大小和sized trait</h3><ul><li>Rust需要在编译时确定为一个特定类型的值分配多少空间</li><li>动态大小的类型（Dynamically Sized Types，DST）的概念： <ul><li>编写代码时使用只有在运行时才能确定大小的值</li></ul></li><li>str是动态大小的类型（注意：不是&amp;str）：只有在运行时才能确定字符串长度 <ul><li>下面代码无法正常工作 <ul><li><code>let s1:str = &quot;Hello there!&quot;;</code></li><li><code>let s2:str = &quot;How&#39;s it going?&quot;;</code></li></ul></li><li>使用<code>&amp;str</code>来解决： <ul><li>存储的是str的地址</li><li>以及str的长度</li><li>字符串切片这个类型它的大小是固定的</li></ul></li></ul></li></ul><h3 id="rust使用动态大小类型的通用方式" tabindex="-1"><a class="header-anchor" href="#rust使用动态大小类型的通用方式" aria-hidden="true">#</a> Rust使用动态大小类型的通用方式</h3><ul><li>附带一些额外的元数据来存储动态信息的大小 <ul><li>使用动态大小类型时总会把他的值放在某种指针后面</li></ul></li></ul><h3 id="另外一种动态大小的类型-trait" tabindex="-1"><a class="header-anchor" href="#另外一种动态大小的类型-trait" aria-hidden="true">#</a> 另外一种动态大小的类型：trait</h3><ul><li>每个trait都是一个动态大小的类型，可以通过名称对其进行引用</li><li>为了将trait用作trait对象，必须将它放置在某种指针之后 <ul><li>例如<code>&amp;dyn Trait</code>或<code>Box&lt;dyn Trait&gt;</code>（<code>Rc&lt;dyn Trait&gt;</code>）之后</li></ul></li></ul><h3 id="sized-trait" tabindex="-1"><a class="header-anchor" href="#sized-trait" aria-hidden="true">#</a> Sized Trait</h3><ul><li>为了处理动态大小的类型，Rust提供了一个Sized trait来确定一个类型的大小在编译时是否已知 <ul><li>编译时可计算出大小的类型会自动实现这一trait</li></ul></li><li>默认情况下，泛型函数只能用于编译时就已经知道大小的类型，可以通过特殊语法解除这一限制</li></ul><h3 id="sized-trait约束" tabindex="-1"><a class="header-anchor" href="#sized-trait约束" aria-hidden="true">#</a> ?Sized trait约束</h3><div class="language-rust line-numbers-mode" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">generic</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token class-name">Sized</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>t<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// --snip--</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_19-4-高级函数和闭包" tabindex="-1"><a class="header-anchor" href="#_19-4-高级函数和闭包" aria-hidden="true">#</a> 19.4 高级函数和闭包</h2><h3 id="函数指针" tabindex="-1"><a class="header-anchor" href="#函数指针" aria-hidden="true">#</a> 函数指针</h3><ul><li>可以将函数传递给其他函数</li><li>函数在传递过程中会被强制转换成fn类型</li><li><code>fn</code>类型就是“函数指针（function pointer）”</li></ul><div class="language-rust line-numbers-mode" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">add_one</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">i32</span> <span class="token punctuation">{</span>
    x <span class="token operator">+</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">do_twice</span><span class="token punctuation">(</span>f<span class="token punctuation">:</span> <span class="token keyword">fn</span><span class="token punctuation">(</span><span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">i32</span><span class="token punctuation">,</span> arg<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">i32</span> <span class="token punctuation">{</span>
    <span class="token function">f</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">f</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> answer <span class="token operator">=</span> <span class="token function">do_twice</span><span class="token punctuation">(</span>add_one<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;The answer is: {}&quot;</span><span class="token punctuation">,</span> answer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="函数指针与闭包的不同" tabindex="-1"><a class="header-anchor" href="#函数指针与闭包的不同" aria-hidden="true">#</a> 函数指针与闭包的不同</h3><ul><li>fn是一个类型，不是一个trait <ul><li>可以直接指定fn作为参数类型，不用声明一个以fn trait为约束的泛型参数</li></ul></li><li>函数指针实现了全部3种闭包trait（Fn，FnMut，FnOnce） <ul><li>总是可以把函数指针用作参数传递给一个接收闭包的参数</li><li>所以，倾向于搭配闭包trait的泛型来编写函数：可以同时接收闭包和普通函数</li></ul></li><li>某些情景，只想接收fn而不接受闭包： <ul><li>与外部不支持闭包的代码交互：C函数</li></ul></li></ul><div class="language-rust line-numbers-mode" data-ext="rs"><pre class="language-rust"><code><span class="token comment">// 使用闭包</span>
<span class="token keyword">let</span> list_of_numbers <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> list_of_strings<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span> <span class="token operator">=</span>
    list_of_numbers<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>i<span class="token closure-punctuation punctuation">|</span></span> i<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用函数</span>
<span class="token keyword">let</span> list_of_numbers <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> list_of_strings<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span> <span class="token operator">=</span>
    list_of_numbers<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">ToString</span><span class="token punctuation">::</span>to_string<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-rust line-numbers-mode" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">enum</span> <span class="token type-definition class-name">Status</span> <span class="token punctuation">{</span>
    <span class="token class-name">Value</span><span class="token punctuation">(</span><span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Stop</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> list_of_statuses<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Status</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0u32</span><span class="token punctuation">..</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Status</span><span class="token punctuation">::</span><span class="token class-name">Value</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="返回闭包" tabindex="-1"><a class="header-anchor" href="#返回闭包" aria-hidden="true">#</a> 返回闭包</h3><div class="language-rust line-numbers-mode" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">returns_closure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">Fn</span><span class="token punctuation">(</span><span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">i32</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_19-5-宏" tabindex="-1"><a class="header-anchor" href="#_19-5-宏" aria-hidden="true">#</a> 19.5 宏</h2><ul><li>宏在Rust里指的是一组相关特性的集合称谓： <ul><li>使用<code>macro_rules!</code>构建的声明宏（declarative macro）</li><li>三种过程宏 <ul><li>自定义<code>#[derive]</code>宏用于struct或enum，可以为其指定随derive属性添加的代码</li><li>类似属性的宏，在任何条目上添加自定义属性</li><li>类似函数的宏，看起来像函数调用，对其指定为参数的token进行操作</li></ul></li></ul></li></ul><h3 id="函数和宏的差别" tabindex="-1"><a class="header-anchor" href="#函数和宏的差别" aria-hidden="true">#</a> 函数和宏的差别</h3><ul><li>本质上，宏是用来编写可以生成其他代码的代码（元编程，metaprogramming）</li><li>函数在定义签名时，必须声明参数的个数和类型，宏可以处理可变的参数</li></ul><div class="language-rust line-numbers-mode" data-ext="rs"><pre class="language-rust"><code><span class="token attribute attr-name">#[macro_export]</span>
<span class="token macro property">macro_rules!</span> vec <span class="token punctuation">{</span>
    <span class="token punctuation">(</span> $<span class="token punctuation">(</span> <span class="token variable">$x</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">expr</span> <span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> temp_vec <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            $<span class="token punctuation">(</span>
                temp_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token variable">$x</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">)</span><span class="token operator">*</span>
            temp_vec
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="基于属性生成代码的过程宏" tabindex="-1"><a class="header-anchor" href="#基于属性生成代码的过程宏" aria-hidden="true">#</a> 基于属性生成代码的过程宏</h3><ul><li>这种形式更像函数（某种形式的过程）一些 <ul><li>接收并操作输入的Rust代码</li><li>生成另外一些Rust代码作为结果</li></ul></li><li>三种过程宏 <ul><li>自定义派生</li><li>属性宏</li><li>函数宏</li></ul></li><li>创建宏的过程时必须单独放在它们自己的包中，并使用特殊的包的类型</li></ul><div class="language-rust line-numbers-mode" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">use</span> proc_macro<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[some_attribute]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">some_name</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token class-name">TokenStream</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">TokenStream</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,93),o=[e];function c(l,i){return s(),a("div",null,o)}const r=n(p,[["render",c],["__file","19-.html.vue"]]);export{r as default};
